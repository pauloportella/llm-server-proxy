FROM python:3.11-slim

WORKDIR /app

# Install git (required for transformers install from github)
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Install uv for fast dependency management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Install ROCm PyTorch + torchvision FIRST (critical for AMD GPU acceleration)
RUN uv pip install --system --pre torch torchvision pytorch-triton-rocm \
    --index-url https://download.pytorch.org/whl/nightly/rocm7.0

# Install transformers from git (for latest Qwen3-VL support transformers>=4.57.0)
RUN uv pip install --system \
    "git+https://github.com/huggingface/transformers.git" \
    "accelerate>=1.2.1" \
    "fastapi>=0.115.0" \
    "uvicorn>=0.32.0" \
    "pydantic>=2.10.0" \
    "pillow>=11.1.0" \
    "requests>=2.32.0" \
    "qwen-vl-utils>=0.0.8"

# Copy server script
COPY vision_server.py .

# Run server
CMD ["python", "vision_server.py"]
